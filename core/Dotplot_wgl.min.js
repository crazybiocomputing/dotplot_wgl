/*! Dotplot_wgl 0.9.0 2014-04-30 */
/*
 *  dotplot_wgl: Dot-Plot implementation in JavaScript and WebGL..
 *  Copyright (C) 2014  Jean-Christophe Taveau.
 *
 *  This file is part of dotplot_wgl.
 *
 *  dotplot_wgl is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  dotplot_wgl is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with dotplot_wgl.  If not, see <http://www.gnu.org/licenses/>
 *
 * Authors:
 * Rania Assab
 * Aurélien Luciani
 * Quentin Riché-Piotaix
 * Mathieu Schaeffer
 */
"use strict";var g={dbVersion:1,db:null,context:null,program:null,seqMgr:{},matMgr:{},viewMgr:{},DOM:{liTempl:function(){var a=document.createElement("li"),b=document.createElement("div");return a.appendChild(b.cloneNode(!0)),a.appendChild(b.cloneNode(!0)),b.classList.add("remove"),b.textContent="×",a.appendChild(b),a}(),transform:function(){for(var a=document.createElement("div"),b=["transform","MozTransform","WebkitTransform","OTransform","msTransform"],c=0;c<b.length;c++)if(void 0!==a.style[b[c]])return b[c]}()},transf:function(){var a=new ArrayBuffer(1),b=new Worker(URL.createObjectURL(new Blob([""],{type:"application/javascript"})));return b.postMessage(a,[a]),0===a.byteLength}(),rAF:function(){return window.requestAnimationFrame?function(a){window.requestAnimationFrame(a)}:window.webkitRequestAnimationFrame?function(a){window.webkitRequestAnimationFrame(a)}:window.mozRequestAnimationFrame?function(a){window.mozRequestAnimationFrame(a)}:function(a){setTimeout(a,16)}}(),executeAfterDOM:function(a){"loading"!==document.readyState?a():document.addEventListener("DOMContentLoaded",a,!1)},$:function(a){return document.getElementById(a)},xhr2:function(a,b,c){var d=new XMLHttpRequest;d.open("GET",a,!0),d.responseType=c,d.addEventListener("load",function(){200===this.status&&b(this.response)},!1),d.send()}};g.executeAfterDOM(function(){g.DOM.canvas=g.$("canvas"),g.DOM.li=g.$("sequence-list");var a=document.getElementsByTagName("select");g.DOM.opt1=a[0],g.DOM.opt2=a[1],g.DOM.mat=a[2],g.DOM.type=a[3],g.DOM.names=g.$("names"),g.DOM.inputZone=g.$("input-zone"),g.DOM.hist=g.$("svg");var b=document.getElementsByClassName("range");g.DOM.range1=b[0],g.DOM.range2=b[1];var c=document.getElementsByClassName("channel");g.DOM.colors=g.$("hist").firstChild,g.DOM.red=c[0],g.DOM.green=c[1],g.DOM.blue=c[2],g.DOM.zoom=g.$("zoom"),g.DOM.windowSize=g.$("window"),g.DOM.windowSize.getValue=function(){return Math.max(Math.round(this.value),1)};var d=document.getElementsByClassName("picking-slider");g.DOM.slider1=d[0],g.DOM.slider2=d[1],g.DOM.pick=g.$("picking-sequences-cont");var e=document.getElementsByClassName("pickers");g.DOM.picker1=e[0],g.DOM.picker2=e[1]}),g.xhr2("matrices/NucleicMatrices.texture",function(a){g.nucleicTex=new Uint8Array(a)},"arraybuffer"),g.xhr2("matrices/ProteicMatrices.texture",function(a){g.proteicTex=new Uint8Array(a)},"arraybuffer"),g.executeAfterDOM(function(){var a=g.$("inner-container");a.style[g.DOM.transform]="translateZ(0) scale(1)",a.addEventListener("click",function(a){var b=this.getBoundingClientRect();g.viewMgr.pick(Math.floor((a.clientX-b.left-a.target.clientLeft+a.target.scrollLeft)*g.DOM.zoom.value),Math.floor((a.clientY-b.top-a.target.clientTop+a.target.scrollTop)*g.DOM.zoom.value))},!1);var b=function(b){a.style[g.DOM.transform]=a.style[g.DOM.transform].replace(/scale\(\d+\.?\d*\)/,"scale("+1/b+")")};if(g.$("container").addEventListener("wheel",function(a){(a.ctrlKey||a.altKey||a.shiftKey)&&(a.preventDefault(),a.deltaY&&b(g.DOM.zoom.value=Math.max(parseFloat((parseFloat(g.DOM.zoom.value)+(a.deltaY>0?.1:-.1)).toFixed(1)),.1)))}),document.addEventListener("keypress",function(a){(43===a.charCode||45===a.charCode)&&b(g.DOM.zoom.value=Math.max(parseFloat((parseFloat(g.DOM.zoom.value)+(45===a.charCode?.1:-.1)).toFixed(1)),.1))},!1),g.DOM.zoom.addEventListener("input",function(){b(this.value)},!1),g.DOM.zoom.addEventListener("change",function(){b(this.value)},!1),g.DOM.mat.addEventListener("change",function(){g.context&&!g.viewMgr.rendering&&(g.viewMgr.rendering=!0,g.DOM.range1.value=255,g.DOM.range2.value=0,g.DOM.hist.style.background="",g.context.clear(g.context.COLOR_BUFFER_BIT|g.context.DEPTH_BUFFER_BIT),g.context.uniform2f(g.context.getUniformLocation(g.program,"uTransfer"),1,0),g.context.uniform1i(g.context.getUniformLocation(g.program,"uWindow"),g.DOM.windowSize.getValue()),g.context.uniform2f(g.context.getUniformLocation(g.program,"uOffset"),parseFloat(g.DOM.mat.selectedOptions[0].dataset.offset0),parseFloat(g.DOM.mat.selectedOptions[0].dataset.offset1)),g.viewMgr.draw(!0))}),g.DOM.windowSize.addEventListener("input",function(){g.context&&!g.viewMgr.rendering&&(g.viewMgr.rendering=!0,g.DOM.range1.value=255,g.DOM.range2.value=0,g.DOM.hist.style.background="",g.context.clear(g.context.COLOR_BUFFER_BIT|g.context.DEPTH_BUFFER_BIT),g.context.uniform2f(g.context.getUniformLocation(g.program,"uTransfer"),1,0),g.context.uniform1i(g.context.getUniformLocation(g.program,"uWindow"),g.DOM.windowSize.getValue()),g.viewMgr.draw(!0))}),g.$("download").addEventListener("click",function(){var a=g.$("ghost-anchor");a.download="image.png";try{g.DOM.canvas.toBlob(function(b){a.href=window.URL.createObjectURL(b),a.click()})}catch(b){a.href=g.DOM.canvas.toDataURL(),a.click()}},!1),g.$("fullscreen").addEventListener("click",function(){document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen()},!1),g.$("clean-up").addEventListener("click",function(){window.indexedDB.deleteDatabase("dotplot");try{localStorage.removeItem("alreadyVisited")}catch(a){}location.reload(!0)},!1),window.Notification&&"granted"!==window.Notification.permission?g.$("notifications").addEventListener("click",function(){window.Notification.requestPermission(function(a){"granted"===a&&new window.Notification("Success",{body:"Notifications will now be used when importing sequences",icon:"images/favicon-128.png"})})},!1):g.$("notifications").classList.add("hidden"),navigator.mozApps){var c=location.href.substring(0,location.href.lastIndexOf("/"))+"/manifest.webapp",d=navigator.mozApps.checkInstalled(c);d.addEventListener("success",function(a){a.result?g.$("install").classList.add("hidden"):g.$("install").addEventListener("click",function(){var a=navigator.mozApps.install(c);a.addEventListener("success",function(){alert("Installed successfully. Tou can now close this tab and open your application like any other application")},!1),a.addEventListener("error",function(a){alert("Error: "+a.name)},!1)},!1)},!1)}else g.$("install").classList.add("hidden");var e=function(){g.$(this.dataset.target).classList.toggle("active-section")};Array.prototype.forEach.call(document.getElementsByClassName("internal-nav"),function(a){a.addEventListener("click",e,!1)}),g.$("sequence-list").addEventListener("click",function(a){a.target.classList.contains("remove")&&g.seqMgr.remove(parseInt(a.target.dataset.key))},!1);var f=function(){g.DOM.names.value="",g.DOM.type.value="unknown",g.DOM.inputZone.value=""};g.DOM.inputZone.addEventListener("dragover",function(a){a.stopPropagation(),a.preventDefault(),g.DOM.inputZone.classList.add("hovering"),a.dataTransfer.dropEffect="copy"},!1),g.DOM.inputZone.addEventListener("dragleave",function(a){a.stopPropagation(),a.preventDefault(),g.DOM.inputZone.classList.remove("hovering")},!1),g.DOM.inputZone.addEventListener("drop",function(a){a.stopPropagation(),a.preventDefault(),g.DOM.inputZone.classList.remove("hovering"),Array.prototype.forEach.call(a.dataTransfer.files,function(a){g.seqMgr.add(a,g.DOM.names.value,g.DOM.type.value)}),f()},!1),g.$("input-submit").addEventListener("click",function(){g.seqMgr.add(g.DOM.inputZone.value,g.DOM.names.value,g.DOM.type.value),f()},!1);var h=document.createDocumentFragment(),i=document.createElementNS("http://www.w3.org/2000/svg","line");i.classList.add("count"),i.setAttribute("y1","200.5%"),i.setAttribute("y2","100.5%"),i.style.stroke="#06F",i.style.strokeWidth=1;var j=document.createElementNS("http://www.w3.org/2000/svg","line");j.classList.add("log"),j.setAttribute("y1","101.5%"),j.setAttribute("y2","100.5%"),j.style.stroke="#f0e",j.style.strokeWidth=1;for(var k=.5;256>k;k++){var l=i.cloneNode();l.setAttribute("x1",k),l.setAttribute("x2",k),h.appendChild(l);var m=j.cloneNode();m.setAttribute("x1",k),m.setAttribute("x2",k),h.appendChild(m)}g.DOM.hist.appendChild(h);var n=function(){if(g.context&&!g.viewMgr.rendering){g.viewMgr.rendering=!0;var a=g.DOM.range1.value/2.55,b=g.DOM.range2.value/2.55,c=(g.DOM.red.checked?"f":"0")+(g.DOM.green.checked?"f":"0")+(g.DOM.blue.checked?"f":"0");g.DOM.hist.style.background=a>=b?"linear-gradient(to right, #000 0, #000 "+b+"%, #"+c+" "+a+"%, #"+c+" 100%)":"linear-gradient(to right, #"+c+" 0, #"+c+" "+a+"%, #000 "+b+"%, #000 100%)",g.DOM.countHist((g.DOM.red.checked?"R":"")+(g.DOM.green.checked?"G":"")+(g.DOM.blue.checked?"B":"")),g.context.uniform3i(g.context.getUniformLocation(g.program,"uColors"),g.DOM.red.checked?1:0,g.DOM.green.checked?1:0,g.DOM.blue.checked?1:0),g.viewMgr.draw(!1)}};g.DOM.red.addEventListener("change",n,!1),g.DOM.green.addEventListener("change",n,!1),g.DOM.blue.addEventListener("change",n,!1);var o=function(a,b){var c=100/(b-a);return{a:c,b:-c*a/100}},p=function(){if(g.context&&!g.viewMgr.rendering){g.viewMgr.rendering=!0;var a=g.DOM.range1.value/2.55,b=g.DOM.range2.value/2.55,c=(g.DOM.red.checked?"f":"0")+(g.DOM.green.checked?"f":"0")+(g.DOM.blue.checked?"f":"0");g.DOM.hist.style.background=a>=b?"linear-gradient(to right, #000 0, #000 "+b+"%, #"+c+" "+a+"%, #"+c+" 100%)":"linear-gradient(to right, #"+c+" 0, #"+c+" "+a+"%, #000 "+b+"%, #000 100%)";var d=o(b,a);g.context.uniform2f(g.context.getUniformLocation(g.program,"uTransfer"),d.a,d.b),g.viewMgr.draw(!1)}};g.DOM.range1.addEventListener("input",p,!1),g.DOM.range2.addEventListener("input",p,!1),g.DOM.slider1.addEventListener("input",function(a){g.viewMgr.pick(a.target.value)},!1),g.DOM.slider2.addEventListener("input",function(a){g.viewMgr.pick(null,a.target.value)},!1)});var viewer=function(){g.viewMgr.rendering=!1;var a,b,c={},d=function(c){var d=a.createShader(a.VERTEX_SHADER);a.shaderSource(d,g.viewMgr.DotPlot),a.compileShader(d),a.attachShader(b,d);var e=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(e,g.viewMgr[c]),a.compileShader(e),a.attachShader(b,e)},e=function(c){console.time("1"),g.DOM.range1.value=255,g.DOM.range2.value=0,g.DOM.red.checked=!0,g.DOM.green.checked=!0,g.DOM.blue.checked=!0,g.DOM.hist.style.background="linear-gradient(to right, #000 0, #000 0%, #fff 100%, #fff 100%)",g.DOM.slider1.value=0,g.DOM.slider2.value=0;var e,f,i=g.DOM.windowSize.getValue();switch(c.compType%2?3===c.compType?(e=Math.floor(c.seq1.size/3),f=c.seq2.size):(e=c.seq1.size,f=Math.floor(c.seq2.size/3)):(e=c.seq1.size,f=c.seq2.size),g.$("window-viewer").style.width=i+"ch",g.DOM.canvas.width=e,g.DOM.canvas.height=f,g.DOM.canvas.style.width=e+"px",g.DOM.canvas.style.height=f+"px",g.DOM.picker1.style.height=f+1-i+"px",g.DOM.picker2.style.width=e+1-i+"px",a=g.context=g.DOM.canvas.getContext("webgl",{alpha:!1,preserveDrawingBuffer:!0})||g.DOM.canvas.getContext("experimental-webgl",{alpha:!1,preserveDrawingBuffer:!0}),a.viewport(0,0,e,f),a.clearColor(1,1,1,1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),b=g.program=a.createProgram(),c.compType){case 0:d("ProteicProteic");break;case 1:d("ProteicNucleic");break;case 2:d("NucleicNucleic");break;case 3:d("NucleicProteic")}a.linkProgram(b),a.useProgram(b),a.bindBuffer(a.ARRAY_BUFFER,a.createBuffer()),a.bufferData(a.ARRAY_BUFFER,new Float32Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]),a.STATIC_DRAW);var j=a.getAttribLocation(b,"aVertexPosition");a.enableVertexAttribArray(j),a.vertexAttribPointer(j,2,a.FLOAT,!1,0,0),a.uniform1i(a.getUniformLocation(b,"uSamplerMat"),0),a.uniform1i(a.getUniformLocation(b,"uSampler1"),1),a.uniform1i(a.getUniformLocation(b,"uSampler2"),2),a.uniform2f(a.getUniformLocation(b,"uSizes"),e,f),a.uniform2f(a.getUniformLocation(b,"uOffset"),parseFloat(g.DOM.mat.selectedOptions[0].dataset.offset0),parseFloat(g.DOM.mat.selectedOptions[0].dataset.offset1)),a.uniform1i(a.getUniformLocation(b,"uWindow"),i),a.uniform3i(a.getUniformLocation(b,"uColors"),1,1,1),a.uniform2f(a.getUniformLocation(b,"uTransfer"),1,0),a.bindBuffer(a.ARRAY_BUFFER,a.createBuffer()),a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,0,0,1,1,0,1]),a.STATIC_DRAW);var k=a.getAttribLocation(b,"aTexCoord");a.enableVertexAttribArray(k),a.vertexAttribPointer(k,2,a.FLOAT,!1,0,0);var l=2===c.compType?16:24,m=2===c.compType?g.nucleicTex:g.proteicTex;a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,a.createTexture()),a.texImage2D(a.TEXTURE_2D,0,a.LUMINANCE,l,m.length/l,0,a.LUMINANCE,a.UNSIGNED_BYTE,m),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);var n=!1;g.seqMgr.get(c.seq1.key,2===c.compType,function(b,d){g.DOM.slider1.max=e-1,g.DOM.pickDiv1=document.createElement("div"),g.DOM.pickDiv1.title=c.seq1.name,h(d,c.compType,"1"),g.DOM.pick.replaceChild(g.DOM.pickDiv1,g.DOM.pick.children[0]),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,a.createTexture()),"nucleic"===c.seq1.type?a.texImage2D(a.TEXTURE_2D,0,a.RGB,e,1,0,a.RGB,a.UNSIGNED_BYTE,b):a.texImage2D(a.TEXTURE_2D,0,a.LUMINANCE,e,1,0,a.LUMINANCE,a.UNSIGNED_BYTE,b),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),n?g.viewMgr.draw(!0):n=!0}),g.seqMgr.get(c.seq2.key,2===c.compType,function(b,d){g.DOM.slider2.max=f-1,g.DOM.pickDiv2=document.createElement("div"),g.DOM.pickDiv2.title=c.seq2.name,h(d,c.compType,"2"),g.DOM.pick.replaceChild(g.DOM.pickDiv2,g.DOM.pick.children[1]),a.activeTexture(a.TEXTURE2),a.bindTexture(a.TEXTURE_2D,a.createTexture()),"nucleic"===c.seq2.type?a.texImage2D(a.TEXTURE_2D,0,a.RGB,f,1,0,a.RGB,a.UNSIGNED_BYTE,b):a.texImage2D(a.TEXTURE_2D,0,a.LUMINANCE,f,1,0,a.LUMINANCE,a.UNSIGNED_BYTE,b),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),n?g.viewMgr.draw(!0):n=!0})},f=function(a){for(var b=document.createElement("div"),c=0;c<a.length;c++){var d=document.createElement("span");d.textContent=a.charAt(c),b.appendChild(d)}return b},h=function(a,b,c){var d=g.DOM["pickDiv"+c];switch(d.classList.add("picking-sequences"),b+c){case"22":d.appendChild(f(a[0]));break;case"12":case"21":case"31":a.forEach(function(a){d.appendChild(f(a))});break;default:d.appendChild(f(a))}},i=function(){var b=new Worker("core/workers/histogram.min.js");b.addEventListener("message",function(a){Object.keys(a.data).forEach(function(b){c[b]=a.data[b]}),g.DOM.countHist("RGB")},!1);var d=g.DOM.windowSize.getValue(),e=new Uint8Array((g.DOM.canvas.width+1-d)*(g.DOM.canvas.height+1-d)*4);a.readPixels(0,d-1,g.DOM.canvas.width+1-d,g.DOM.canvas.height+1-d,a.RGBA,a.UNSIGNED_BYTE,e),b.postMessage({pixels:e,transf:g.transf})};g.viewMgr.draw=function(b){a.drawArrays(a.TRIANGLES,0,6),b&&(i(),g.viewMgr.pick(0,0)),g.$("window-viewer").style.width=g.DOM.windowSize.getValue()+"ch";var c=g.$("webgl");c.value="Render WebGL graph",g.rAF(function(){c.disabled=!1}),g.viewMgr.rendering=!1,console.timeEnd("1")},g.DOM.countHist=function(a){for(var b=0;256>b;b++)g.DOM.hist.children[2*b].style[g.DOM.transform]="translate3d(0, -"+200*(a?c.histCount[a][b]/c.maxCount[a]:0)+"px, 0)",g.DOM.hist.children[2*b+1].style[g.DOM.transform]="translate3d(0, -"+200*(a?c.histLog[a][b]/c.maxLog[a]:0)+"px, 0)";a||(g.DOM.hist.children[0].style[g.DOM.transform]="translate3d(0, -200px, 0)",g.DOM.hist.children[1].style[g.DOM.transform]="translate3d(0, -200px, 0)")},g.viewMgr.pick=function(a,b){void 0!==a&&a<g.DOM.canvas.width&&(g.DOM.slider1.value=Math.min(a,g.DOM.slider1.max),g.DOM.pickDiv1.style[g.DOM.transform]="translateZ(0) translateX(-"+a+"ch)",g.DOM.picker1.style[g.DOM.transform]="translateZ(0) translateX("+a+"px)"),void 0!==b&&b<g.DOM.canvas.height&&(g.DOM.slider2.value=Math.min(b,g.DOM.slider2.max),g.DOM.pickDiv2.style[g.DOM.transform]="translateZ(0) translateX(-"+b+"ch)",g.DOM.picker2.style[g.DOM.transform]="translateZ(0) translateY("+b+"px)")},["DotPlot.vs","NucleicNucleic.fs","NucleicProteic.fs","ProteicNucleic.fs","ProteicProteic.fs"].forEach(function(a){g.xhr2("shaders/"+a,function(b){g.viewMgr[a.split(".")[0]]=b})}),g.executeAfterDOM(function(){var a=g.$("webgl");a.addEventListener("click",function(){if(!g.viewMgr.rendering){g.viewMgr.rendering=!0,a.disabled=!0,a.value="Rendering…",g.DOM.red.disabled=!1,g.DOM.green.disabled=!1,g.DOM.blue.disabled=!1;var b,c=g.DOM.opt1.selectedOptions[0],d=g.DOM.opt2.selectedOptions[0];c.dataset.type===d.dataset.type?"nucleic"===d.dataset.type?(b=2,g.DOM.colors.textContent="Nucleic strand:",g.DOM.red.nextElementSibling.textContent="forward",g.DOM.green.nextElementSibling.textContent="reverse",g.DOM.blue.nextElementSibling.textContent="reverse comp."):(b=0,g.DOM.red.disabled=!0,g.DOM.green.disabled=!0,g.DOM.blue.disabled=!0,g.DOM.colors.textContent="",g.DOM.red.nextElementSibling.textContent="",g.DOM.green.nextElementSibling.textContent="",g.DOM.blue.nextElementSibling.textContent=""):(g.DOM.colors.textContent="Reading frame offsets:",g.DOM.red.nextElementSibling.textContent="0",g.DOM.green.nextElementSibling.textContent="1",g.DOM.blue.nextElementSibling.textContent="2",b="nucleic"===d.dataset.type?1:3),e({seq1:{type:c.dataset.type,key:parseInt(c.dataset.key),name:c.textContent,size:parseInt(c.dataset.size)},seq2:{type:d.dataset.type,key:parseInt(d.dataset.key),name:d.textContent,size:parseInt(d.dataset.size)},compType:b})}},!1),a.disabled=!1})},sequences=function(){var a=[],b=function(a){a.forEach(function(a){a.opt1=document.createElement("option"),a.opt1.value=a.key,a.opt1.textContent=a.name,a.opt1.dataset.type=a.type,a.opt1.dataset.size=a.size,a.opt1.dataset.key=a.key,a.opt2=a.opt1.cloneNode(!0),g.DOM.opt1.appendChild(a.opt1),g.DOM.opt2.appendChild(a.opt2),a.li=g.DOM.liTempl.cloneNode(!0),a.li.children[2].dataset.key=a.key,a.li.children[1].textContent="("+a.size+("proteic"===a.type?" aa)":" bp)"),a.li.children[0].textContent=a.name,a.li.dataset.type=a.type,g.DOM.li.appendChild(a.li)})};g.seqMgr.add=function(a,b,d){var e=new Worker("core/workers/seqInput.min.js"),f=0,h=0,i=0;e.addEventListener("message",function(a){switch(a.data.status){case"error":window.Notification&&"granted"===window.Notification.permission&&new window.Notification("Error",{body:a.data.message,icon:"images/favicon-128.png"});break;case"sequence":f++,"proteic"===a.data.type?h++:i++,c(a.data);break;case"done":window.Notification&&"granted"===window.Notification.permission&&new window.Notification(f+" sequence"+(f>1?"s":"")+" imported",{body:"nucleic: "+i+" ; proteic: "+h,tag:parseInt(Date.now()/2e3),icon:"images/favicon-128.png"})}},!1),e.postMessage({rawInput:a,proposedNames:b,type:d,transf:g.transf})},g.seqMgr.remove=function(b){for(var c,d=0;d<a.length;d++)if(a[d].key===b){c=a.splice(d,1)[0];break}if(c){if(g.db){var e=g.db.transaction(["sequences","sequencesMetadata"],"readwrite");e.addEventListener("complete",function(){console.log("removed "+c.name)},!1),e.objectStore("sequences").delete(b),e.objectStore("sequencesMetadata").delete(b)}g.DOM.li.removeChild(c.li),g.DOM.opt1.removeChild(c.opt1),g.DOM.opt2.removeChild(c.opt2)}};var c;if(g.db){c=function(c){var d,e=g.db.transaction(["sequences","sequencesMetadata"],"readwrite"),f=e.objectStore("sequences");d=f.add("proteic"===c.type?{proteic:c.proteic,proteicS:c.proteicS}:{nucleic:c.nucleic,nucleicS:c.nucleicS,proteic:c.proteic,proteicS:c.proteicS}),d.addEventListener("success",function(d){var f=e.objectStore("sequencesMetadata"),g={name:c.name,type:c.type,size:c.size,comment:c.comment,key:d.target.result},h=f.add(g);h.addEventListener("success",function(){a.push(g),b([g])})},!1)},g.seqMgr.get=function(a,b,c){var d=b?"nucleic":"proteic";g.db.transaction(["sequences"],"readonly").objectStore("sequences").get(a).addEventListener("success",function(a){c(a.target.result[d],a.target.result[d+"S"])},!1)};var d=g.db.transaction(["sequencesMetadata"],"readonly").objectStore("sequencesMetadata").openCursor();d.addEventListener("success",function(c){var d=c.target.result;d?(a.push(d.value),d.continue()):(g.executeAfterDOM(function(){b(a),g.matMgr.updateDOM()}),viewer())},!1)}else c=function(c){var d={name:c.name,type:c.type,size:c.size,comment:c.comment,key:Date.now(),proteic:c.proteic,proteicS:c.proteicS};"nucleic"===c.type&&(d.nucleic=c.nucleic,d.nucleicS=c.nucleicS),a.push(d),b([d])},g.seqMgr.get=function(b,c,d){for(var e,f=c?"nucleic":"proteic",g=0;g<a.length;g++)if(a[g].key===b){e=a[g];break}e&&d(e[f],e[f+"S"])},viewer()},matrices=function(){var a=[];g.matMgr.updateDOM=function(){var b;try{b="nucleic"===g.DOM.opt2.selectedOptions[0].dataset.type&&"nucleic"===g.DOM.opt1.selectedOptions[0].dataset.type?"nucleic":"proteic"}catch(c){return}this.currentType!==b&&(a.forEach(function(a){if(a.dataset.type===b)g.DOM.mat.appendChild(a);else try{g.DOM.mat.removeChild(a)}catch(c){}}),this.currentType=b)};var b=function(b,c,d){var e=document.createElement("option");e.textContent=b,e.dataset.type=this.type,e.dataset.offset0=c*this.size/(this.size*d.length),e.dataset.offset1=this.size/(this.size*d.length),a.push(e)};["Blosum 30","Blosum 35","Blosum 40","Blosum 45","Blosum 50","Blosum 55","Blosum 60","Blosum 62-12","Blosum 62","Blosum 65","Blosum 70","Blosum 75","Blosum 80","Blosum 85","Blosum 90","Blosum N","Identity","PAM 10","PAM 20","PAM 30","PAM 40","PAM 50","PAM 60","PAM 70","PAM 80","PAM 90","PAM 100","PAM 110","PAM 120","PAM 130","PAM 140","PAM 150","PAM 160","PAM 170","PAM 180","PAM 190","PAM 200","PAM 210","PAM 220","PAM 230","PAM 240","PAM 250","PAM 260","PAM 270","PAM 280","PAM 290","PAM 300","PAM 310","PAM 320","PAM 330","PAM 340","PAM 350","PAM 360","PAM 370","PAM 380","PAM 390","PAM 400","PAM 410","PAM 420","PAM 430","PAM 440","PAM 450","PAM 460","PAM 470","PAM 480","PAM 490","PAM 500"].forEach(b,{type:"proteic",size:576}),["DNA Full","Identity"].forEach(b,{type:"nucleic",size:256}),g.executeAfterDOM(function(){g.matMgr.updateDOM(),g.DOM.opt1.addEventListener("change",g.matMgr.updateDOM,!1),g.DOM.opt2.addEventListener("change",g.matMgr.updateDOM,!1)}),sequences()};!function(){var a=document.createElement("canvas");window.Worker&&window.WebGLRenderingContext&&(a.getContext("webgl")||a.getContext("experimental-webgl"))?g.executeAfterDOM(function(){g.$("compatibility").classList.add("hidden")}):document.addEventListener("click",function(){g.$("compatibility").classList.add("hidden"),document.removeEventListener("click",arguments.callee,!1)},!1);var b=function(){var a=document.createElement("script");a.src="core/firstLoad.min.js",document.head.appendChild(a)};if(window.indexedDB){var c=window.indexedDB.open("dotplot",g.dbVersion);c.addEventListener("error",function(){console.log("Error opening the DB, loading data in memory"),setTimeout(function(){matrices(),b()},100)},!1),c.addEventListener("success",function(a){g.db=a.target.result,matrices(),localStorage.getItem("alreadyVisited")||b()},!1),c.addEventListener("upgradeneeded",function(a){g.db=a.target.result,g.db.objectStoreNames.contains("sequencesMetadata")||g.db.createObjectStore("sequencesMetadata",{keyPath:"key"}),g.db.objectStoreNames.contains("sequences")||g.db.createObjectStore("sequences",{autoIncrement:!0})},!1)}else matrices(),b()}();