/*! Dotplot_wgl 1.0.0 2014-05-15 */
/*
 *  dotplot_wgl: Dot-Plot implementation in JavaScript and WebGL..
 *  Copyright (C) 2014  Jean-Christophe Taveau.
 *
 *  This file is part of dotplot_wgl.
 *
 *  dotplot_wgl is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  dotplot_wgl is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with dotplot_wgl.  If not, see <http://www.gnu.org/licenses/>
 *
 * Authors:
 * Rania Assab
 * Aurélien Luciani
 * Quentin Riché-Piotaix
 * Mathieu Schaeffer
 */
"use strict";function ViewManager(){var a,b,c,d,e={},f={},h=[];this.rendering=!1,["DotPlot.vs","NucleicNucleic.fs","NucleicProteic.fs","ProteicNucleic.fs","ProteicProteic.fs"].forEach(function(a){g.xhr2("shaders/"+a,function(b){f[a.split(".")[0]]=b})});var i=function(a){var b=c.createShader(c.VERTEX_SHADER);c.shaderSource(b,f.DotPlot),c.compileShader(b),c.attachShader(d,b);var e=c.createShader(c.FRAGMENT_SHADER);c.shaderSource(e,f[a]),c.compileShader(e),c.attachShader(d,e)};this.render=function(a,b,e){g.DOM.range1.value=255,g.DOM.range2.value=0,g.DOM.red.checked=g.DOM.green.checked=g.DOM.blue.checked=!0,g.DOM.hist.style.background="linear-gradient(to right, #000 0, #000 0%, #fff 100%, #fff 100%)",g.DOM.slider1.value=0,g.DOM.slider2.value=0;var f,h,j=g.DOM.windowSize.getValue();switch(e%2?3===e?(f=Math.floor(a.size/3),h=b.size):(f=a.size,h=Math.floor(b.size/3)):(f=a.size,h=b.size),g.$("window-viewer").style.width=j+"ch",g.DOM.canvas.width=f,g.DOM.canvas.height=h,g.DOM.canvas.style.width=f+"px",g.DOM.canvas.style.height=h+"px",g.DOM.picker1.style.height=h+1-j+"px",g.DOM.picker2.style.width=f+1-j+"px",c=g.context=g.DOM.canvas.getContext("webgl",{alpha:!1,preserveDrawingBuffer:!0})||g.DOM.canvas.getContext("experimental-webgl",{alpha:!1,preserveDrawingBuffer:!0}),c.viewport(0,0,f,h),c.clearColor(1,1,1,1),c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),d=g.program=c.createProgram(),e){case 0:i("ProteicProteic");break;case 1:i("ProteicNucleic");break;case 2:i("NucleicNucleic");break;case 3:i("NucleicProteic")}c.linkProgram(d),c.useProgram(d),c.bindBuffer(c.ARRAY_BUFFER,c.createBuffer()),c.bufferData(c.ARRAY_BUFFER,new Float32Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]),c.STATIC_DRAW);var k=c.getAttribLocation(d,"aVertexPosition");c.enableVertexAttribArray(k),c.vertexAttribPointer(k,2,c.FLOAT,!1,0,0),c.uniform1i(c.getUniformLocation(d,"uSamplerMat"),0),c.uniform1i(c.getUniformLocation(d,"uSampler1"),1),c.uniform1i(c.getUniformLocation(d,"uSampler2"),2),c.uniform2f(c.getUniformLocation(d,"uSizes"),f,h),c.uniform2f(c.getUniformLocation(d,"uOffset"),parseFloat(g.DOM.mat.options[g.DOM.mat.selectedIndex].dataset.offset0),parseFloat(g.DOM.mat.options[g.DOM.mat.selectedIndex].dataset.offset1)),c.uniform1i(c.getUniformLocation(d,"uWindow"),j),c.uniform3i(c.getUniformLocation(d,"uColors"),1,1,1),c.uniform2f(c.getUniformLocation(d,"uTransfer"),1,0),c.bindBuffer(c.ARRAY_BUFFER,c.createBuffer()),c.bufferData(c.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,0,0,1,1,0,1]),c.STATIC_DRAW);var m=c.getAttribLocation(d,"aTexCoord");c.enableVertexAttribArray(m),c.vertexAttribPointer(m,2,c.FLOAT,!1,0,0);var n=2===e?16:24,o=g.matMgr.getTexture(e);c.activeTexture(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,c.createTexture()),c.texImage2D(c.TEXTURE_2D,0,c.LUMINANCE,n,o.length/n,0,c.LUMINANCE,c.UNSIGNED_BYTE,o),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST);var p=!1;g.seqMgr.get(a.key,2===e,function(b){g.DOM.slider1.max=f-2,g.DOM.pickDiv1=document.createElement("div"),g.DOM.pickDiv1.title=a.name,l(b.string,e,"1"),g.DOM.pick.replaceChild(g.DOM.pickDiv1,g.DOM.pick.children[0]),c.activeTexture(c.TEXTURE1),c.bindTexture(c.TEXTURE_2D,c.createTexture()),"nucleic"===a.type?c.texImage2D(c.TEXTURE_2D,0,c.RGB,f,1,0,c.RGB,c.UNSIGNED_BYTE,b.typedArray):c.texImage2D(c.TEXTURE_2D,0,c.LUMINANCE,f,1,0,c.LUMINANCE,c.UNSIGNED_BYTE,b.typedArray),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),p?g.viewMgr.draw(!0):p=!0}),g.seqMgr.get(b.key,2===e,function(a){g.DOM.slider2.max=h-2,g.DOM.pickDiv2=document.createElement("div"),g.DOM.pickDiv2.title=b.name,l(a.string,e,"2"),g.DOM.pick.replaceChild(g.DOM.pickDiv2,g.DOM.pick.children[1]),c.activeTexture(c.TEXTURE2),c.bindTexture(c.TEXTURE_2D,c.createTexture()),"nucleic"===b.type?c.texImage2D(c.TEXTURE_2D,0,c.RGB,h,1,0,c.RGB,c.UNSIGNED_BYTE,a.typedArray):c.texImage2D(c.TEXTURE_2D,0,c.LUMINANCE,h,1,0,c.LUMINANCE,c.UNSIGNED_BYTE,a.typedArray),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),p?g.viewMgr.draw(!0):p=!0})};var j,k=function(a,b,c){for(var d=document.createDocumentFragment(),e=0;200>e&&c+e<a.length;){var f=document.createElement("span");f.textContent=a.charAt(c+e),d.appendChild(f),e++}b.appendChild(d),c+e<a.length&&setTimeout(k,50,a,b,c+200)},l=function(a,b,c){var d=g.DOM["pickDiv"+c];switch(d.classList.add("picking-sequences"),b+c){case"22":var e=document.createElement("div");d.appendChild(e),k(a[0],e,0);break;case"12":case"21":case"31":a.forEach(function(a){var b=document.createElement("div");d.appendChild(b),k(a,b,0)});break;default:var e=document.createElement("div");d.appendChild(e),k(a,e,0)}},m=function(){var a=new Worker("core/workers/histogram.min.js");a.addEventListener("message",function(a){Object.keys(a.data).forEach(function(b){e[b]=a.data[b]}),g.DOM.countHist("RGB")},!1);var b=g.DOM.windowSize.getValue(),d=new Uint8Array((g.DOM.canvas.width+1-b)*(g.DOM.canvas.height+1-b)*4);c.readPixels(b,b,g.DOM.canvas.width-2*b,g.DOM.canvas.height+1-2*b,c.RGBA,c.UNSIGNED_BYTE,d),g.transf?a.postMessage({pixels:d,transf:g.transf},[d.buffer]):a.postMessage({pixels:d,transf:g.transf})},n=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||setTimeout;this.draw=function(a){c.drawArrays(c.TRIANGLES,0,6),a&&(m(),g.viewMgr.pick({x:0,y:0})),j.style.width=2*g.DOM.windowSize.getValue()+1+"ch",n(function(){g.viewMgr.rendering=!1},16)},g.DOM.countHist=function(a){for(var b=0;256>b;b++)g.DOM.hist.children[2*b].style[g.DOM.transform]="translate3d(0, -"+200*(a?e.histCount[a][b]/e.maxCount[a]:0)+"px, 0)",g.DOM.hist.children[2*b+1].style[g.DOM.transform]="translate3d(0, -"+200*(a?e.histLog[a][b]/e.maxLog[a]:0)+"px, 0)";a||(g.DOM.hist.children[0].style[g.DOM.transform]="translate3d(0, -200px, 0)",g.DOM.hist.children[1].style[g.DOM.transform]="translate3d(0, -200px, 0)")},this.pick=function(d){var e=!1,f=!1;if((d.x||0===d.x)&&d.x<g.DOM.canvas.width&&d.x!==a&&(a=d.x,e=!0),d.dx&&d.dx+a<g.DOM.canvas.width&&(a+=d.dx,e=!0),e&&(g.DOM.slider1.value=a,g.DOM.pickDiv1.style[g.DOM.transform]="translateZ(0) translateX(-"+a+"ch)",g.DOM.picker1.style[g.DOM.transform]="translateZ(0) translateX("+a+"px)"),(d.y||0===d.y)&&d.y<g.DOM.canvas.height&&d.y!==b&&(b=d.y,f=!0),d.dy&&d.dy+b<g.DOM.canvas.height&&(b+=d.dy,f=!0),f&&(g.DOM.slider1.value=a,g.DOM.pickDiv2.style[g.DOM.transform]="translateZ(0) translateX(-"+b+"ch)",g.DOM.picker2.style[g.DOM.transform]="translateZ(0) translateY("+b+"px)"),e||f){var i=new Uint8Array(4);c.readPixels(a,g.DOM.canvas.height-b-1,1,1,c.RGBA,c.UNSIGNED_BYTE,i),h.forEach(function(a){a.style.background=a.style.textShadow=""}),h=[];var j=3===g.DOM.pickDiv2.childElementCount?g.DOM.pickDiv2:g.DOM.pickDiv1,k=3===g.DOM.pickDiv2.childElementCount?b:a;Array.prototype.forEach.call(j.children,function(a){var b=a.children[k];b.style.textShadow="1px 1px white",h.push(b)}),1===h.length?h[0].style.background="rgb("+i[0]+", "+i[1]+", "+i[2]+")":(h[0].style.background="rgb("+i[0]+", 0, 0)",h[1].style.background="rgb(0, "+i[1]+", 0)",h[2].style.background="rgb(0, 0, "+i[2]+")")}},g.executeAfterDOM(function(){var a=g.$("hist").firstChild;g.$("render").addEventListener("click",function(){if(!g.viewMgr.rendering){g.viewMgr.rendering=!0,g.DOM.red.disabled=g.DOM.green.disabled=g.DOM.blue.disabled=!1;var b,c=g.DOM.opt1.options[g.DOM.opt1.selectedIndex],d=g.DOM.opt2.options[g.DOM.opt2.selectedIndex];c.dataset.type===d.dataset.type?"nucleic"===d.dataset.type?(b=2,a.textContent="Nucleic strand:",g.DOM.red.nextElementSibling.textContent="forward",g.DOM.green.nextElementSibling.textContent="reverse",g.DOM.blue.nextElementSibling.textContent="reverse comp."):(b=0,g.DOM.red.disabled=g.DOM.green.disabled=g.DOM.blue.disabled=!0,a.textContent=g.DOM.red.nextElementSibling.textContent=g.DOM.green.nextElementSibling.textContent=g.DOM.blue.nextElementSibling.textContent=""):(a.textContent="Reading frame offsets:",g.DOM.red.nextElementSibling.textContent="0",g.DOM.green.nextElementSibling.textContent="1",g.DOM.blue.nextElementSibling.textContent="2",b="nucleic"===d.dataset.type?1:3),g.viewMgr.render({type:c.dataset.type,key:parseInt(c.dataset.key),name:c.textContent,size:parseInt(c.dataset.size)},{type:d.dataset.type,key:parseInt(d.dataset.key),name:d.textContent,size:parseInt(d.dataset.size)},b)}},!1),j=g.$("window-viewer")})}function SequenceManager(){var a=[],b=g.$("sequence-list"),c=function(){for(var a=document.createElement("li"),b=0;4>b;b++)a.appendChild(document.createElement("div"));return a.children[2].classList.add("download"),a.children[2].title="save as fasta file",a.children[2].textContent="↓",a.children[3].classList.add("remove"),a.children[3].title="remove",a.children[3].textContent="×",a}(),d=function(a){a.forEach(function(a){a.opt1=document.createElement("option"),a.opt1.value=a.key,a.opt1.textContent=a.name,a.opt1.dataset.type=a.type,a.opt1.dataset.size=a.size,a.opt1.dataset.key=a.key,a.opt2=a.opt1.cloneNode(!0),g.DOM.opt1.appendChild(a.opt1),g.DOM.opt2.appendChild(a.opt2),a.li=c.cloneNode(!0),a.li.dataset.key=a.key,a.li.children[1].textContent="("+a.size+("proteic"===a.type?" aa)":" bp)"),a.li.children[0].textContent=a.name,a.li.dataset.type=a.type,b.appendChild(a.li)})};this.add=function(a,b,c){var d=new Worker("core/workers/seqInput.min.js"),f=0,h=0,i=0;d.addEventListener("message",function(a){switch(a.data.status){case"error":window.Notification&&"granted"===window.Notification.permission?new window.Notification("Error",{body:a.data.message,icon:"images/favicon-128.png"}):alert("Error: "+a.data.message);break;case"sequence":f++,"proteic"===a.data.type?h++:i++,e(a.data);break;case"done":window.Notification&&"granted"===window.Notification.permission&&new window.Notification(f+" sequence"+(f>1?"s":"")+" imported",{body:"nucleic: "+i+" ; proteic: "+h,tag:parseInt(Date.now()/2e3),icon:"images/favicon-128.png"})}},!1),d.postMessage({rawInput:a,proposedNames:b,type:c,transf:g.transf})},this.remove=function(c){for(var d,e=0;e<a.length;e++)if(a[e].key===c){d=a.splice(e,1)[0];break}if(d){if(g.db){var f=g.db.transaction(["sequences","sequencesMetadata"],"readwrite");f.addEventListener("complete",function(){console.log("removed "+d.name)},!1),f.objectStore("sequences").delete(c),f.objectStore("sequencesMetadata").delete(c)}b.removeChild(d.li),g.DOM.opt1.removeChild(d.opt1),g.DOM.opt2.removeChild(d.opt2)}},this.fasta=function(a,b,c){this.get(a,b,function(a){var d=new Worker("core/workers/fasta.min.js");d.addEventListener("message",function(a){c(window.URL.createObjectURL(a.data.blob),a.data.name)},!1),d.postMessage({string:b?a.string[0]:a.string,name:a.name,comment:a.comment,nucleic:b})},!0)};var e=function(){return g.db?function(b){var c,e=g.db.transaction(["sequences","sequencesMetadata"],"readwrite"),f=e.objectStore("sequences");c=f.add("proteic"===b.type?{proteic:b.proteic,proteicS:b.proteicS}:{nucleic:b.nucleic,nucleicS:b.nucleicS,proteic:b.proteic,proteicS:b.proteicS}),c.addEventListener("success",function(c){var f=e.objectStore("sequencesMetadata"),g={name:b.name,type:b.type,size:b.size,comment:b.comment,key:c.target.result},h=f.add(g);h.addEventListener("success",function(){a.push(g),d([g])})},!1)}:function(b){var c={name:b.name,type:b.type,size:b.size,comment:b.comment,key:Date.now()+parseInt(10*Math.random()),proteic:b.proteic,proteicS:b.proteicS};"nucleic"===b.type&&(c.nucleic=b.nucleic,c.nucleicS=b.nucleicS),a.push(c),d([c])}}();if(this.get=function(){return g.db?function(a,b,c,d){var e=b?"nucleic":"proteic";if(d){var f=g.db.transaction(["sequences","sequencesMetadata"],"readonly"),h={};f.addEventListener("complete",function(){c(h)},!1),f.objectStore("sequencesMetadata").get(a).addEventListener("success",function(a){h.name=a.target.result.name,h.comment=a.target.result.comment},!1),f.objectStore("sequences").get(a).addEventListener("success",function(a){h.string=a.target.result[e+"S"]},!1)}else g.db.transaction(["sequences"],"readonly").objectStore("sequences").get(a).addEventListener("success",function(a){c({string:a.target.result[e+"S"],typedArray:a.target.result[e]})},!1)}:function(b,c,d,e){for(var f,g=c?"nucleic":"proteic",h=0;h<a.length;h++)if(a[h].key===b){f=a[h];break}f&&d(e?{string:f[g+"S"],name:f.name,comment:f.comment}:{string:f[g+"S"],typedArray:f[g]})}}(),g.db){var f=g.db.transaction(["sequencesMetadata"],"readonly").objectStore("sequencesMetadata").openCursor();f.addEventListener("success",function(b){var c=b.target.result;c?(a.push(c.value),c.continue()):(g.executeAfterDOM(function(){d(a),g.matMgr.updateDOM()}),g.viewMgr=new ViewManager)},!1)}else g.executeAfterDOM(function(){g.matMgr.updateDOM()}),g.viewMgr=new ViewManager}function MatrixManager(){var a,b=[],c=null,d=null;g.xhr2("matrices/NucleicMatrices.texture",function(a){c=new Uint8Array(a)},"arraybuffer"),g.xhr2("matrices/ProteicMatrices.texture",function(a){d=new Uint8Array(a)},"arraybuffer"),this.updateDOM=function(){var c;try{c="nucleic"===g.DOM.opt2.options[g.DOM.opt2.selectedIndex].dataset.type&&"nucleic"===g.DOM.opt1.options[g.DOM.opt1.selectedIndex].dataset.type?"nucleic":"proteic"}catch(d){}a!==c&&(b.forEach(function(a){if(a.dataset.type===c)g.DOM.mat.appendChild(a);else try{g.DOM.mat.removeChild(a)}catch(b){}}),a=c)},this.getTexture=function(a){return 2===a?c:d};var e=function(a,c,d){var e=document.createElement("option");e.textContent=a,e.dataset.type=this.type,e.dataset.offset0=c*this.size/(this.size*d.length),e.dataset.offset1=this.size/(this.size*d.length),b.push(e)};["Blosum 30","Blosum 35","Blosum 40","Blosum 45","Blosum 50","Blosum 55","Blosum 60","Blosum 62-12","Blosum 62","Blosum 65","Blosum 70","Blosum 75","Blosum 80","Blosum 85","Blosum 90","Blosum N","Identity","PAM 10","PAM 20","PAM 30","PAM 40","PAM 50","PAM 60","PAM 70","PAM 80","PAM 90","PAM 100","PAM 110","PAM 120","PAM 130","PAM 140","PAM 150","PAM 160","PAM 170","PAM 180","PAM 190","PAM 200","PAM 210","PAM 220","PAM 230","PAM 240","PAM 250","PAM 260","PAM 270","PAM 280","PAM 290","PAM 300","PAM 310","PAM 320","PAM 330","PAM 340","PAM 350","PAM 360","PAM 370","PAM 380","PAM 390","PAM 400","PAM 410","PAM 420","PAM 430","PAM 440","PAM 450","PAM 460","PAM 470","PAM 480","PAM 490","PAM 500"].forEach(e,{type:"proteic",size:576}),["DNA Full","Identity"].forEach(e,{type:"nucleic",size:256}),function(a){g.executeAfterDOM(function(){a.updateDOM(),g.DOM.opt1.addEventListener("change",a.updateDOM,!1),g.DOM.opt2.addEventListener("change",a.updateDOM,!1)})}(this)}var g={DOM:{transform:function(){for(var a=document.createElement("div"),b=["transform","MozTransform","WebkitTransform","OTransform","msTransform"],c=0;c<b.length;c++)if(void 0!==a.style[b[c]])return b[c]}()},transf:function(){var a=new ArrayBuffer(1),b=new Worker(URL.createObjectURL(new Blob([""],{type:"application/javascript"})));return b.postMessage(a,[a]),0===a.byteLength}(),executeAfterDOM:function(a){"loading"!==document.readyState?a():document.addEventListener("DOMContentLoaded",a,!1)},$:function(a){return document.getElementById(a)},xhr2:function(a,b,c){var d=new XMLHttpRequest;d.open("GET",a,!0),d.responseType=c,d.addEventListener("load",function(){200===this.status&&b(this.response)},!1),d.send()}};g.executeAfterDOM(function(){g.DOM.canvas=g.$("canvas");var a=document.getElementsByTagName("select");g.DOM.opt1=a[0],g.DOM.opt2=a[1],g.DOM.mat=a[2],g.DOM.type=a[3],g.DOM.names=g.$("names"),g.DOM.inputZone=g.$("input-zone"),g.DOM.hist=g.$("svg");var b=document.getElementsByClassName("range");g.DOM.range1=b[0],g.DOM.range2=b[1];var c=document.getElementsByClassName("channel");g.DOM.red=c[0],g.DOM.green=c[1],g.DOM.blue=c[2],g.DOM.zoom=g.$("zoom"),g.DOM.windowSize=g.$("window"),g.DOM.windowSize.getValue=function(){return Math.max(Math.round((this.value-1)/2),0)};var d=document.getElementsByClassName("picking-slider");g.DOM.slider1=d[0],g.DOM.slider2=d[1],g.DOM.pick=g.$("picking-sequences-cont");var e=document.getElementsByClassName("pickers");g.DOM.picker1=e[0],g.DOM.picker2=e[1]}),g.executeAfterDOM(function(){var a=function(){g.$(this.dataset.target).classList.toggle("active-section")};Array.prototype.forEach.call(document.getElementsByClassName("internal-nav"),function(b){b.addEventListener("click",a,!1)}),g.DOM.mat.addEventListener("change",function(){g.context&&!g.viewMgr.rendering&&(g.viewMgr.rendering=!0,g.DOM.range1.value=255,g.DOM.range2.value=0,g.DOM.hist.style.background="",g.context.clear(g.context.COLOR_BUFFER_BIT|g.context.DEPTH_BUFFER_BIT),g.context.uniform2f(g.context.getUniformLocation(g.program,"uTransfer"),1,0),g.context.uniform1i(g.context.getUniformLocation(g.program,"uWindow"),g.DOM.windowSize.getValue()),g.DOM.red.checked=g.DOM.green.checked=g.DOM.blue.checked=!0,g.context.uniform3i(g.context.getUniformLocation(g.program,"uColors"),1,1,1),g.context.uniform2f(g.context.getUniformLocation(g.program,"uOffset"),parseFloat(g.DOM.mat.options[g.DOM.mat.selectedIndex].dataset.offset0),parseFloat(g.DOM.mat.options[g.DOM.mat.selectedIndex].dataset.offset1)),g.viewMgr.draw(!0))}),g.DOM.windowSize.addEventListener("input",function(){g.context&&!g.viewMgr.rendering&&(g.viewMgr.rendering=!0,g.DOM.range1.value=255,g.DOM.range2.value=0,g.DOM.hist.style.background="",g.context.clear(g.context.COLOR_BUFFER_BIT|g.context.DEPTH_BUFFER_BIT),g.context.uniform2f(g.context.getUniformLocation(g.program,"uTransfer"),1,0),g.context.uniform1i(g.context.getUniformLocation(g.program,"uWindow"),g.DOM.windowSize.getValue()),g.viewMgr.draw(!0))});var b=g.$("inner-container");b.style[g.DOM.transform]="translateZ(0) scale(1)",b.addEventListener("click",function(a){var b=this.getBoundingClientRect();g.viewMgr.pick({x:Math.floor((a.clientX-b.left-a.target.clientLeft+a.target.scrollLeft)*g.DOM.zoom.value),y:Math.floor((a.clientY-b.top-a.target.clientTop+a.target.scrollTop)*g.DOM.zoom.value)})},!1);var c=function(a){g.DOM.zoom.value>1&&1>a?(b.style.imageRendering="-moz-crisp-edges",b.style.imageRendering="-webkit-optimize-contrast",b.style.imageRendering="pixelate"):g.DOM.zoom.value<1&&a>1&&(b.style.imageRendering=""),b.style[g.DOM.transform]=b.style[g.DOM.transform].replace(/scale\(\d+\.?\d*\)/,"scale("+1/a+")")};g.$("container").addEventListener("wheel",function(a){(a.ctrlKey||a.altKey||a.shiftKey)&&(a.preventDefault(),a.deltaY&&c(g.DOM.zoom.value=Math.max(parseFloat((parseFloat(g.DOM.zoom.value)+(a.deltaY>0?.1:-.1)).toFixed(1)),.1)))});var d={37:{dx:-1},38:{dy:-1},39:{dx:1},40:{dy:1}};document.addEventListener("keydown",function(a){try{g.viewMgr.pick(d[a.keyCode]),a.preventDefault()}catch(b){109===a.keyCode?c(g.DOM.zoom.value=Math.max(parseFloat((parseFloat(g.DOM.zoom.value)+.1).toFixed(1)),.1)):107===a.keyCode&&c(g.DOM.zoom.value=Math.max(parseFloat((parseFloat(g.DOM.zoom.value)+-.1).toFixed(1)),.1))}},!1),g.DOM.zoom.addEventListener("input",function(){c(this.value)},!1),g.DOM.zoom.addEventListener("change",function(){c(this.value)},!1),g.$("download").addEventListener("click",function(){var a=g.$("ghost-anchor");a.download="image.png";try{g.DOM.canvas.toBlob(function(b){a.href=window.URL.createObjectURL(b),a.click()})}catch(b){a.href=g.DOM.canvas.toDataURL(),a.click()}},!1),g.$("fullscreen").addEventListener("click",function(){document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen()},!1),g.$("clean-up").addEventListener("click",function(){window.indexedDB.deleteDatabase("dotplot");try{localStorage.removeItem("alreadyVisited")}catch(a){}location.reload(!0)},!1),window.Notification&&"granted"!==window.Notification.permission?g.$("notifications").addEventListener("click",function(){window.Notification.requestPermission(function(a){"granted"===a&&new window.Notification("Success",{body:"Notifications will now be used when importing sequences",icon:"images/favicon-128.png"})})},!1):g.$("notifications").classList.add("hidden"),g.$("sequence-list").addEventListener("click",function(a){a.target.classList.contains("remove")?g.seqMgr.remove(parseInt(a.target.parentElement.dataset.key)):a.target.classList.contains("download")&&g.seqMgr.fasta(parseInt(a.target.parentElement.dataset.key),"nucleic"===a.target.parentElement.dataset.type,function(a,b){var c=g.$("ghost-anchor");c.download=b+".fasta",c.href=a,c.click()})},!1),g.DOM.inputZone.addEventListener("dragover",function(a){a.stopPropagation(),a.preventDefault(),g.DOM.inputZone.classList.add("hovering"),a.dataTransfer.dropEffect="copy"},!1),g.DOM.inputZone.addEventListener("dragleave",function(a){a.stopPropagation(),a.preventDefault(),g.DOM.inputZone.classList.remove("hovering")},!1),g.DOM.inputZone.addEventListener("drop",function(a){a.stopPropagation(),a.preventDefault(),g.DOM.inputZone.classList.remove("hovering"),Array.prototype.forEach.call(a.dataTransfer.files,function(a){g.seqMgr.add(a,g.DOM.names.value,g.DOM.type.value)}),g.DOM.names.value=g.DOM.inputZone.value="",g.DOM.type.value="unknown"},!1),g.$("input-submit").addEventListener("click",function(){g.seqMgr.add(g.DOM.inputZone.value,g.DOM.names.value,g.DOM.type.value),g.DOM.names.value=g.DOM.inputZone.value="",g.DOM.type.value="unknown"},!1),function(){var a=document.createDocumentFragment(),b=document.createElementNS("http://www.w3.org/2000/svg","line");b.classList.add("count"),b.setAttribute("y1","200.5%"),b.setAttribute("y2","100.5%"),b.style.stroke="#06F",b.style.strokeWidth=1;var c=document.createElementNS("http://www.w3.org/2000/svg","line");c.classList.add("log"),c.setAttribute("y1","101.5%"),c.setAttribute("y2","100.5%"),c.style.stroke="#f0e",c.style.strokeWidth=1;for(var d=.5;256>d;d++){var e=b.cloneNode();e.setAttribute("x1",d),e.setAttribute("x2",d),a.appendChild(e);var f=c.cloneNode();f.setAttribute("x1",d),f.setAttribute("x2",d),a.appendChild(f)}g.DOM.hist.appendChild(a)}();var e=function(){if(g.context&&!g.viewMgr.rendering){g.viewMgr.rendering=!0;var a=g.DOM.range1.value/2.55,b=g.DOM.range2.value/2.55,c=(g.DOM.red.checked?"f":"0")+(g.DOM.green.checked?"f":"0")+(g.DOM.blue.checked?"f":"0");g.DOM.hist.style.background=a>=b?"linear-gradient(to right, #000 0, #000 "+b+"%, #"+c+" "+a+"%, #"+c+" 100%)":"linear-gradient(to right, #"+c+" 0, #"+c+" "+a+"%, #000 "+b+"%, #000 100%)",g.DOM.countHist((g.DOM.red.checked?"R":"")+(g.DOM.green.checked?"G":"")+(g.DOM.blue.checked?"B":"")),g.context.uniform3i(g.context.getUniformLocation(g.program,"uColors"),g.DOM.red.checked?1:0,g.DOM.green.checked?1:0,g.DOM.blue.checked?1:0),g.viewMgr.draw(!1)}};g.DOM.red.addEventListener("change",e,!1),g.DOM.green.addEventListener("change",e,!1),g.DOM.blue.addEventListener("change",e,!1);var f=function(a,b){var c=100/(b-a);return{a:c,b:-c*a/100}},h=function(){if(g.context&&!g.viewMgr.rendering){g.viewMgr.rendering=!0;var a=g.DOM.range1.value/2.55,b=g.DOM.range2.value/2.55,c=(g.DOM.red.checked?"f":"0")+(g.DOM.green.checked?"f":"0")+(g.DOM.blue.checked?"f":"0");g.DOM.hist.style.background=a>=b?"linear-gradient(to right, #000 0, #000 "+b+"%, #"+c+" "+a+"%, #"+c+" 100%)":"linear-gradient(to right, #"+c+" 0, #"+c+" "+a+"%, #000 "+b+"%, #000 100%)";var d=f(b,a);g.context.uniform2f(g.context.getUniformLocation(g.program,"uTransfer"),d.a,d.b),g.viewMgr.draw(!1)}};g.DOM.range1.addEventListener("input",h,!1),g.DOM.range2.addEventListener("input",h,!1),g.DOM.slider1.addEventListener("input",function(a){g.viewMgr.pick({x:a.target.value})},!1),g.DOM.slider2.addEventListener("input",function(a){g.viewMgr.pick({y:a.target.value})},!1)}),function(){var a=document.createElement("canvas");if(window.Worker&&window.WebGLRenderingContext&&(a.getContext("webgl")||a.getContext("experimental-webgl")))g.executeAfterDOM(function(){g.$("compatibility").classList.add("hidden")});else{var b=function(){g.$("compatibility").classList.add("hidden"),document.removeEventListener("click",b,!1)};document.addEventListener("click",b,!1)}var c=function(){var a=document.createElement("script");a.src="core/firstLoad.min.js",document.head.appendChild(a)};if(window.indexedDB){var d=window.indexedDB.open("dotplot",1);d.addEventListener("error",function(){console.log("Error opening the DB, loading data in memory"),setTimeout(function(){g.matMgr=new MatrixManager,g.seqMgr=new SequenceManager,c()},100)},!1),d.addEventListener("success",function(a){g.db=a.target.result,g.matMgr=new MatrixManager,g.seqMgr=new SequenceManager,localStorage.getItem("alreadyVisited")||c()},!1),d.addEventListener("upgradeneeded",function(a){g.db=a.target.result,g.db.objectStoreNames.contains("sequencesMetadata")||g.db.createObjectStore("sequencesMetadata",{keyPath:"key"}),g.db.objectStoreNames.contains("sequences")||g.db.createObjectStore("sequences",{autoIncrement:!0})},!1)}else g.matMgr=new MatrixManager,g.seqMgr=new SequenceManager,c()}();