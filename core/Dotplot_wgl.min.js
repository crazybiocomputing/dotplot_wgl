/*! Dotplot_wgl 0.9.5 2014-05-03 */
/*
 *  dotplot_wgl: Dot-Plot implementation in JavaScript and WebGL..
 *  Copyright (C) 2014  Jean-Christophe Taveau.
 *
 *  This file is part of dotplot_wgl.
 *
 *  dotplot_wgl is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  dotplot_wgl is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with dotplot_wgl.  If not, see <http://www.gnu.org/licenses/>
 *
 * Authors:
 * Rania Assab
 * Aurélien Luciani
 * Quentin Riché-Piotaix
 * Mathieu Schaeffer
 */
"use strict";function ViewManager(){var a,b,c={},d={};this.rendering=!1,["DotPlot.vs","NucleicNucleic.fs","NucleicProteic.fs","ProteicNucleic.fs","ProteicProteic.fs"].forEach(function(a){g.xhr2("shaders/"+a,function(b){d[a.split(".")[0]]=b})});var e=function(c){var e=a.createShader(a.VERTEX_SHADER);a.shaderSource(e,d.DotPlot),a.compileShader(e),a.attachShader(b,e);var f=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(f,d[c]),a.compileShader(f),a.attachShader(b,f)};this.render=function(c,d,f){g.DOM.range1.value=255,g.DOM.range2.value=0,g.DOM.red.checked=g.DOM.green.checked=g.DOM.blue.checked=!0,g.DOM.hist.style.background="linear-gradient(to right, #000 0, #000 0%, #fff 100%, #fff 100%)",g.DOM.slider1.value=0,g.DOM.slider2.value=0;var i,j,k=g.DOM.windowSize.getValue();switch(f%2?3===f?(i=Math.floor(c.size/3),j=d.size):(i=c.size,j=Math.floor(d.size/3)):(i=c.size,j=d.size),g.$("window-viewer").style.width=k+"ch",g.DOM.canvas.width=i,g.DOM.canvas.height=j,g.DOM.canvas.style.width=i+"px",g.DOM.canvas.style.height=j+"px",g.DOM.picker1.style.height=j+1-k+"px",g.DOM.picker2.style.width=i+1-k+"px",a=g.context=g.DOM.canvas.getContext("webgl",{alpha:!1,preserveDrawingBuffer:!0})||g.DOM.canvas.getContext("experimental-webgl",{alpha:!1,preserveDrawingBuffer:!0}),a.viewport(0,0,i,j),a.clearColor(1,1,1,1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),b=g.program=a.createProgram(),f){case 0:e("ProteicProteic");break;case 1:e("ProteicNucleic");break;case 2:e("NucleicNucleic");break;case 3:e("NucleicProteic")}a.linkProgram(b),a.useProgram(b),a.bindBuffer(a.ARRAY_BUFFER,a.createBuffer()),a.bufferData(a.ARRAY_BUFFER,new Float32Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]),a.STATIC_DRAW);var l=a.getAttribLocation(b,"aVertexPosition");a.enableVertexAttribArray(l),a.vertexAttribPointer(l,2,a.FLOAT,!1,0,0),a.uniform1i(a.getUniformLocation(b,"uSamplerMat"),0),a.uniform1i(a.getUniformLocation(b,"uSampler1"),1),a.uniform1i(a.getUniformLocation(b,"uSampler2"),2),a.uniform2f(a.getUniformLocation(b,"uSizes"),i,j),a.uniform2f(a.getUniformLocation(b,"uOffset"),parseFloat(g.DOM.mat.selectedOptions[0].dataset.offset0),parseFloat(g.DOM.mat.selectedOptions[0].dataset.offset1)),a.uniform1i(a.getUniformLocation(b,"uWindow"),k),a.uniform3i(a.getUniformLocation(b,"uColors"),1,1,1),a.uniform2f(a.getUniformLocation(b,"uTransfer"),1,0),a.bindBuffer(a.ARRAY_BUFFER,a.createBuffer()),a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,0,0,1,1,0,1]),a.STATIC_DRAW);var m=a.getAttribLocation(b,"aTexCoord");a.enableVertexAttribArray(m),a.vertexAttribPointer(m,2,a.FLOAT,!1,0,0);var n=2===f?16:24,o=g.matMgr.getTexture(f);a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,a.createTexture()),a.texImage2D(a.TEXTURE_2D,0,a.LUMINANCE,n,o.length/n,0,a.LUMINANCE,a.UNSIGNED_BYTE,o),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);var p=!1;g.seqMgr.get(c.key,2===f,function(b){g.DOM.slider1.max=i-2,g.DOM.pickDiv1=document.createElement("div"),g.DOM.pickDiv1.title=c.name,h(b.string,f,"1"),g.DOM.pick.replaceChild(g.DOM.pickDiv1,g.DOM.pick.children[0]),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,a.createTexture()),"nucleic"===c.type?a.texImage2D(a.TEXTURE_2D,0,a.RGB,i,1,0,a.RGB,a.UNSIGNED_BYTE,b.typedArray):a.texImage2D(a.TEXTURE_2D,0,a.LUMINANCE,i,1,0,a.LUMINANCE,a.UNSIGNED_BYTE,b.typedArray),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),p?g.viewMgr.draw(!0):p=!0}),g.seqMgr.get(d.key,2===f,function(b){g.DOM.slider2.max=j-2,g.DOM.pickDiv2=document.createElement("div"),g.DOM.pickDiv2.title=d.name,h(b.string,f,"2"),g.DOM.pick.replaceChild(g.DOM.pickDiv2,g.DOM.pick.children[1]),a.activeTexture(a.TEXTURE2),a.bindTexture(a.TEXTURE_2D,a.createTexture()),"nucleic"===d.type?a.texImage2D(a.TEXTURE_2D,0,a.RGB,j,1,0,a.RGB,a.UNSIGNED_BYTE,b.typedArray):a.texImage2D(a.TEXTURE_2D,0,a.LUMINANCE,j,1,0,a.LUMINANCE,a.UNSIGNED_BYTE,b.typedArray),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),p?g.viewMgr.draw(!0):p=!0})};var f=function(a,b,c){for(var d=document.createDocumentFragment(),e=0;200>e&&c+e<a.length;){var g=document.createElement("span");g.textContent=a.charAt(c+e),d.appendChild(g),e++}b.appendChild(d),c+e<a.length&&setTimeout(f,50,a,b,c+200)},h=function(a,b,c){var d=g.DOM["pickDiv"+c];switch(d.classList.add("picking-sequences"),b+c){case"22":var e=document.createElement("div");d.appendChild(e),f(a[0],e,0);break;case"12":case"21":case"31":a.forEach(function(a){var b=document.createElement("div");d.appendChild(b),f(a,b,0)});break;default:var e=document.createElement("div");d.appendChild(e),f(a,e,0)}},i=function(){var b=new Worker("core/workers/histogram.min.js");b.addEventListener("message",function(a){Object.keys(a.data).forEach(function(b){c[b]=a.data[b]}),g.DOM.countHist("RGB")},!1);var d=g.DOM.windowSize.getValue(),e=new Uint8Array((g.DOM.canvas.width+1-d)*(g.DOM.canvas.height+1-d)*4);a.readPixels(0,d-1,g.DOM.canvas.width+1-d,g.DOM.canvas.height+1-d,a.RGBA,a.UNSIGNED_BYTE,e),b.postMessage({pixels:e,transf:g.transf})},j=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||setTimeout;this.draw=function(b){a.drawArrays(a.TRIANGLES,0,6),b&&(i(),g.viewMgr.pick(0,0)),g.$("window-viewer").style.width=g.DOM.windowSize.getValue()+"ch",j(function(){g.viewMgr.rendering=!1},16)},g.DOM.countHist=function(a){for(var b=0;256>b;b++)g.DOM.hist.children[2*b].style[g.DOM.transform]="translate3d(0, -"+200*(a?c.histCount[a][b]/c.maxCount[a]:0)+"px, 0)",g.DOM.hist.children[2*b+1].style[g.DOM.transform]="translate3d(0, -"+200*(a?c.histLog[a][b]/c.maxLog[a]:0)+"px, 0)";a||(g.DOM.hist.children[0].style[g.DOM.transform]="translate3d(0, -200px, 0)",g.DOM.hist.children[1].style[g.DOM.transform]="translate3d(0, -200px, 0)")},this.pick=function(a,b){null!==a&&a<g.DOM.canvas.width&&(g.DOM.slider1.value=Math.min(a,g.DOM.slider1.max),g.DOM.pickDiv1.style[g.DOM.transform]="translateZ(0) translateX(-"+a+"ch)",g.DOM.picker1.style[g.DOM.transform]="translateZ(0) translateX("+a+"px)"),null!==b&&b<g.DOM.canvas.height&&(g.DOM.slider2.value=Math.min(b,g.DOM.slider2.max),g.DOM.pickDiv2.style[g.DOM.transform]="translateZ(0) translateX(-"+b+"ch)",g.DOM.picker2.style[g.DOM.transform]="translateZ(0) translateY("+b+"px)")},g.executeAfterDOM(function(){var a=g.$("hist").firstChild;g.$("render").addEventListener("click",function(){if(!g.viewMgr.rendering){g.viewMgr.rendering=!0,g.DOM.red.disabled=g.DOM.green.disabled=g.DOM.blue.disabled=!1;var b,c=g.DOM.opt1.selectedOptions[0],d=g.DOM.opt2.selectedOptions[0];c.dataset.type===d.dataset.type?"nucleic"===d.dataset.type?(b=2,a.textContent="Nucleic strand:",g.DOM.red.nextElementSibling.textContent="forward",g.DOM.green.nextElementSibling.textContent="reverse",g.DOM.blue.nextElementSibling.textContent="reverse comp."):(b=0,g.DOM.red.disabled=g.DOM.green.disabled=g.DOM.blue.disabled=!0,a.textContent=g.DOM.red.nextElementSibling.textContent=g.DOM.green.nextElementSibling.textContent=g.DOM.blue.nextElementSibling.textContent=""):(a.textContent="Reading frame offsets:",g.DOM.red.nextElementSibling.textContent="0",g.DOM.green.nextElementSibling.textContent="1",g.DOM.blue.nextElementSibling.textContent="2",b="nucleic"===d.dataset.type?1:3),g.viewMgr.render({type:c.dataset.type,key:parseInt(c.dataset.key),name:c.textContent,size:parseInt(c.dataset.size)},{type:d.dataset.type,key:parseInt(d.dataset.key),name:d.textContent,size:parseInt(d.dataset.size)},b)}},!1)})}function SequenceManager(){var a=[],b=g.$("sequence-list"),c=function(){for(var a=document.createElement("li"),b=0;4>b;b++)a.appendChild(document.createElement("div"));return a.children[2].classList.add("download"),a.children[2].title="save as fasta file",a.children[2].textContent="↓",a.children[3].classList.add("remove"),a.children[3].title="remove",a.children[3].textContent="×",a}(),d=function(a){a.forEach(function(a){a.opt1=document.createElement("option"),a.opt1.value=a.key,a.opt1.textContent=a.name,a.opt1.dataset.type=a.type,a.opt1.dataset.size=a.size,a.opt1.dataset.key=a.key,a.opt2=a.opt1.cloneNode(!0),g.DOM.opt1.appendChild(a.opt1),g.DOM.opt2.appendChild(a.opt2),a.li=c.cloneNode(!0),a.li.dataset.key=a.key,a.li.children[1].textContent="("+a.size+("proteic"===a.type?" aa)":" bp)"),a.li.children[0].textContent=a.name,a.li.dataset.type=a.type,b.appendChild(a.li)})};this.add=function(a,b,c){var d=new Worker("core/workers/seqInput.min.js"),f=0,h=0,i=0;d.addEventListener("message",function(a){switch(a.data.status){case"error":window.Notification&&"granted"===window.Notification.permission?new window.Notification("Error",{body:a.data.message,icon:"images/favicon-128.png"}):alert("Error: "+a.data.message);break;case"sequence":f++,"proteic"===a.data.type?h++:i++,e(a.data);break;case"done":window.Notification&&"granted"===window.Notification.permission&&new window.Notification(f+" sequence"+(f>1?"s":"")+" imported",{body:"nucleic: "+i+" ; proteic: "+h,tag:parseInt(Date.now()/2e3),icon:"images/favicon-128.png"})}},!1),d.postMessage({rawInput:a,proposedNames:b,type:c,transf:g.transf})},this.remove=function(c){for(var d,e=0;e<a.length;e++)if(a[e].key===c){d=a.splice(e,1)[0];break}if(d){if(g.db){var f=g.db.transaction(["sequences","sequencesMetadata"],"readwrite");f.addEventListener("complete",function(){console.log("removed "+d.name)},!1),f.objectStore("sequences").delete(c),f.objectStore("sequencesMetadata").delete(c)}b.removeChild(d.li),g.DOM.opt1.removeChild(d.opt1),g.DOM.opt2.removeChild(d.opt2)}},this.fasta=function(a,b,c){this.get(a,b,function(a){var d=new Worker("core/workers/fasta.min.js");d.addEventListener("message",function(a){c(window.URL.createObjectURL(a.data.blob),a.data.name)},!1),d.postMessage({string:b?a.string[0]:a.string,name:a.name,comment:a.comment,nucleic:b})},!0)};var e=function(){return g.db?function(b){var c,e=g.db.transaction(["sequences","sequencesMetadata"],"readwrite"),f=e.objectStore("sequences");c=f.add("proteic"===b.type?{proteic:b.proteic,proteicS:b.proteicS}:{nucleic:b.nucleic,nucleicS:b.nucleicS,proteic:b.proteic,proteicS:b.proteicS}),c.addEventListener("success",function(c){var f=e.objectStore("sequencesMetadata"),g={name:b.name,type:b.type,size:b.size,comment:b.comment,key:c.target.result},h=f.add(g);h.addEventListener("success",function(){a.push(g),d([g])})},!1)}:function(b){var c={name:b.name,type:b.type,size:b.size,comment:b.comment,key:Date.now()+parseInt(10*Math.random()),proteic:b.proteic,proteicS:b.proteicS};"nucleic"===b.type&&(c.nucleic=b.nucleic,c.nucleicS=b.nucleicS),a.push(c),d([c])}}();if(this.get=function(){return g.db?function(a,b,c,d){var e=b?"nucleic":"proteic";if(d){var f=g.db.transaction(["sequences","sequencesMetadata"],"readonly"),h={};f.addEventListener("complete",function(){c(h)},!1),f.objectStore("sequencesMetadata").get(a).addEventListener("success",function(a){h.name=a.target.result.name,h.comment=a.target.result.comment},!1),f.objectStore("sequences").get(a).addEventListener("success",function(a){h.string=a.target.result[e+"S"]},!1)}else g.db.transaction(["sequences"],"readonly").objectStore("sequences").get(a).addEventListener("success",function(a){c({string:a.target.result[e+"S"],typedArray:a.target.result[e]})},!1)}:function(b,c,d,e){for(var f,g=c?"nucleic":"proteic",h=0;h<a.length;h++)if(a[h].key===b){f=a[h];break}f&&d(e?{string:f[g+"S"],name:f.name,comment:f.comment}:{string:f[g+"S"],typedArray:f[g]})}}(),g.db){var f=g.db.transaction(["sequencesMetadata"],"readonly").objectStore("sequencesMetadata").openCursor();f.addEventListener("success",function(b){var c=b.target.result;c?(a.push(c.value),c.continue()):(g.executeAfterDOM(function(){d(a),g.matMgr.updateDOM()}),g.viewMgr=new ViewManager)},!1)}else g.viewMgr=new ViewManager}function MatrixManager(){var a=[],b=null,c=null;g.xhr2("matrices/NucleicMatrices.texture",function(a){b=new Uint8Array(a)},"arraybuffer"),g.xhr2("matrices/ProteicMatrices.texture",function(a){c=new Uint8Array(a)},"arraybuffer"),this.updateDOM=function(){var b;try{b="nucleic"===g.DOM.opt2.selectedOptions[0].dataset.type&&"nucleic"===g.DOM.opt1.selectedOptions[0].dataset.type?"nucleic":"proteic"}catch(c){return}this.currentType!==b&&(a.forEach(function(a){if(a.dataset.type===b)g.DOM.mat.appendChild(a);else try{g.DOM.mat.removeChild(a)}catch(c){}}),this.currentType=b)},this.getTexture=function(a){return 2===a?b:c};var d=function(b,c,d){var e=document.createElement("option");e.textContent=b,e.dataset.type=this.type,e.dataset.offset0=c*this.size/(this.size*d.length),e.dataset.offset1=this.size/(this.size*d.length),a.push(e)};["Blosum 30","Blosum 35","Blosum 40","Blosum 45","Blosum 50","Blosum 55","Blosum 60","Blosum 62-12","Blosum 62","Blosum 65","Blosum 70","Blosum 75","Blosum 80","Blosum 85","Blosum 90","Blosum N","Identity","PAM 10","PAM 20","PAM 30","PAM 40","PAM 50","PAM 60","PAM 70","PAM 80","PAM 90","PAM 100","PAM 110","PAM 120","PAM 130","PAM 140","PAM 150","PAM 160","PAM 170","PAM 180","PAM 190","PAM 200","PAM 210","PAM 220","PAM 230","PAM 240","PAM 250","PAM 260","PAM 270","PAM 280","PAM 290","PAM 300","PAM 310","PAM 320","PAM 330","PAM 340","PAM 350","PAM 360","PAM 370","PAM 380","PAM 390","PAM 400","PAM 410","PAM 420","PAM 430","PAM 440","PAM 450","PAM 460","PAM 470","PAM 480","PAM 490","PAM 500"].forEach(d,{type:"proteic",size:576}),["DNA Full","Identity"].forEach(d,{type:"nucleic",size:256}),function(a){g.executeAfterDOM(function(){a.updateDOM(),g.DOM.opt1.addEventListener("change",a.updateDOM,!1),g.DOM.opt2.addEventListener("change",a.updateDOM,!1)})}(this)}var g={DOM:{transform:function(){for(var a=document.createElement("div"),b=["transform","MozTransform","WebkitTransform","OTransform","msTransform"],c=0;c<b.length;c++)if(void 0!==a.style[b[c]])return b[c]}()},transf:function(){var a=new ArrayBuffer(1),b=new Worker(URL.createObjectURL(new Blob([""],{type:"application/javascript"})));return b.postMessage(a,[a]),0===a.byteLength}(),executeAfterDOM:function(a){"loading"!==document.readyState?a():document.addEventListener("DOMContentLoaded",a,!1)},$:function(a){return document.getElementById(a)},xhr2:function(a,b,c){var d=new XMLHttpRequest;d.open("GET",a,!0),d.responseType=c,d.addEventListener("load",function(){200===this.status&&b(this.response)},!1),d.send()}};g.executeAfterDOM(function(){g.DOM.canvas=g.$("canvas");var a=document.getElementsByTagName("select");g.DOM.opt1=a[0],g.DOM.opt2=a[1],g.DOM.mat=a[2],g.DOM.type=a[3],g.DOM.names=g.$("names"),g.DOM.inputZone=g.$("input-zone"),g.DOM.hist=g.$("svg");var b=document.getElementsByClassName("range");g.DOM.range1=b[0],g.DOM.range2=b[1];var c=document.getElementsByClassName("channel");g.DOM.red=c[0],g.DOM.green=c[1],g.DOM.blue=c[2],g.DOM.zoom=g.$("zoom"),g.DOM.windowSize=g.$("window"),g.DOM.windowSize.getValue=function(){return Math.max(Math.round(this.value),1)};var d=document.getElementsByClassName("picking-slider");g.DOM.slider1=d[0],g.DOM.slider2=d[1],g.DOM.pick=g.$("picking-sequences-cont");var e=document.getElementsByClassName("pickers");g.DOM.picker1=e[0],g.DOM.picker2=e[1]}),g.executeAfterDOM(function(){var a=function(){g.$(this.dataset.target).classList.toggle("active-section")};Array.prototype.forEach.call(document.getElementsByClassName("internal-nav"),function(b){b.addEventListener("click",a,!1)}),g.DOM.mat.addEventListener("change",function(){g.context&&!g.viewMgr.rendering&&(g.viewMgr.rendering=!0,g.DOM.range1.value=255,g.DOM.range2.value=0,g.DOM.hist.style.background="",g.context.clear(g.context.COLOR_BUFFER_BIT|g.context.DEPTH_BUFFER_BIT),g.context.uniform2f(g.context.getUniformLocation(g.program,"uTransfer"),1,0),g.context.uniform1i(g.context.getUniformLocation(g.program,"uWindow"),g.DOM.windowSize.getValue()),g.DOM.red.checked=g.DOM.green.checked=g.DOM.blue.checked=!0,g.context.uniform3i(g.context.getUniformLocation(g.program,"uColors"),1,1,1),g.context.uniform2f(g.context.getUniformLocation(g.program,"uOffset"),parseFloat(g.DOM.mat.selectedOptions[0].dataset.offset0),parseFloat(g.DOM.mat.selectedOptions[0].dataset.offset1)),g.viewMgr.draw(!0))}),g.DOM.windowSize.addEventListener("input",function(){g.context&&!g.viewMgr.rendering&&(g.viewMgr.rendering=!0,g.DOM.range1.value=255,g.DOM.range2.value=0,g.DOM.hist.style.background="",g.context.clear(g.context.COLOR_BUFFER_BIT|g.context.DEPTH_BUFFER_BIT),g.context.uniform2f(g.context.getUniformLocation(g.program,"uTransfer"),1,0),g.context.uniform1i(g.context.getUniformLocation(g.program,"uWindow"),g.DOM.windowSize.getValue()),g.viewMgr.draw(!0))});var b=g.$("inner-container");b.style[g.DOM.transform]="translateZ(0) scale(1)",b.addEventListener("click",function(a){var b=this.getBoundingClientRect();g.viewMgr.pick(Math.floor((a.clientX-b.left-a.target.clientLeft+a.target.scrollLeft)*g.DOM.zoom.value),Math.floor((a.clientY-b.top-a.target.clientTop+a.target.scrollTop)*g.DOM.zoom.value))},!1);var c=function(a){b.style[g.DOM.transform]=b.style[g.DOM.transform].replace(/scale\(\d+\.?\d*\)/,"scale("+1/a+")")};if(g.$("container").addEventListener("wheel",function(a){(a.ctrlKey||a.altKey||a.shiftKey)&&(a.preventDefault(),a.deltaY&&c(g.DOM.zoom.value=Math.max(parseFloat((parseFloat(g.DOM.zoom.value)+(a.deltaY>0?.1:-.1)).toFixed(1)),.1)))}),document.addEventListener("keypress",function(a){(43===a.charCode||45===a.charCode)&&c(g.DOM.zoom.value=Math.max(parseFloat((parseFloat(g.DOM.zoom.value)+(45===a.charCode?.1:-.1)).toFixed(1)),.1))},!1),g.DOM.zoom.addEventListener("input",function(){c(this.value)},!1),g.DOM.zoom.addEventListener("change",function(){c(this.value)},!1),g.$("download").addEventListener("click",function(){var a=g.$("ghost-anchor");a.download="image.png";try{g.DOM.canvas.toBlob(function(b){a.href=window.URL.createObjectURL(b),a.click()})}catch(b){a.href=g.DOM.canvas.toDataURL(),a.click()}},!1),g.$("fullscreen").addEventListener("click",function(){document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen()},!1),g.$("clean-up").addEventListener("click",function(){window.indexedDB.deleteDatabase("dotplot");try{localStorage.removeItem("alreadyVisited")}catch(a){}location.reload(!0)},!1),window.Notification&&"granted"!==window.Notification.permission?g.$("notifications").addEventListener("click",function(){window.Notification.requestPermission(function(a){"granted"===a&&new window.Notification("Success",{body:"Notifications will now be used when importing sequences",icon:"images/favicon-128.png"})})},!1):g.$("notifications").classList.add("hidden"),navigator.mozApps){var d=location.href.substring(0,location.href.lastIndexOf("/"))+"/manifest.webapp",e=navigator.mozApps.checkInstalled(d);e.addEventListener("success",function(a){a.result?g.$("install").classList.add("hidden"):g.$("install").addEventListener("click",function(){var a=navigator.mozApps.install(d);a.addEventListener("success",function(){alert("Installed successfully. Tou can now close this tab and open your application like any other application")},!1),a.addEventListener("error",function(a){alert("Error: "+a.name)},!1)},!1)},!1)}else g.$("install").classList.add("hidden");g.$("sequence-list").addEventListener("click",function(a){a.target.classList.contains("remove")?g.seqMgr.remove(parseInt(a.target.parentElement.dataset.key)):a.target.classList.contains("download")&&g.seqMgr.fasta(parseInt(a.target.parentElement.dataset.key),"nucleic"===a.target.parentElement.dataset.type,function(a,b){var c=g.$("ghost-anchor");c.download=b+".fasta",c.href=a,c.click()})},!1),g.DOM.inputZone.addEventListener("dragover",function(a){a.stopPropagation(),a.preventDefault(),g.DOM.inputZone.classList.add("hovering"),a.dataTransfer.dropEffect="copy"},!1),g.DOM.inputZone.addEventListener("dragleave",function(a){a.stopPropagation(),a.preventDefault(),g.DOM.inputZone.classList.remove("hovering")},!1),g.DOM.inputZone.addEventListener("drop",function(a){a.stopPropagation(),a.preventDefault(),g.DOM.inputZone.classList.remove("hovering"),Array.prototype.forEach.call(a.dataTransfer.files,function(a){g.seqMgr.add(a,g.DOM.names.value,g.DOM.type.value)}),g.DOM.names.value=g.DOM.inputZone.value="",g.DOM.type.value="unknown"},!1),g.$("input-submit").addEventListener("click",function(){g.seqMgr.add(g.DOM.inputZone.value,g.DOM.names.value,g.DOM.type.value),g.DOM.names.value=g.DOM.inputZone.value="",g.DOM.type.value="unknown"},!1),function(){var a=document.createDocumentFragment(),b=document.createElementNS("http://www.w3.org/2000/svg","line");b.classList.add("count"),b.setAttribute("y1","200.5%"),b.setAttribute("y2","100.5%"),b.style.stroke="#06F",b.style.strokeWidth=1;var c=document.createElementNS("http://www.w3.org/2000/svg","line");c.classList.add("log"),c.setAttribute("y1","101.5%"),c.setAttribute("y2","100.5%"),c.style.stroke="#f0e",c.style.strokeWidth=1;for(var d=.5;256>d;d++){var e=b.cloneNode();e.setAttribute("x1",d),e.setAttribute("x2",d),a.appendChild(e);var f=c.cloneNode();f.setAttribute("x1",d),f.setAttribute("x2",d),a.appendChild(f)}g.DOM.hist.appendChild(a)}();var f=function(){if(g.context&&!g.viewMgr.rendering){g.viewMgr.rendering=!0;var a=g.DOM.range1.value/2.55,b=g.DOM.range2.value/2.55,c=(g.DOM.red.checked?"f":"0")+(g.DOM.green.checked?"f":"0")+(g.DOM.blue.checked?"f":"0");g.DOM.hist.style.background=a>=b?"linear-gradient(to right, #000 0, #000 "+b+"%, #"+c+" "+a+"%, #"+c+" 100%)":"linear-gradient(to right, #"+c+" 0, #"+c+" "+a+"%, #000 "+b+"%, #000 100%)",g.DOM.countHist((g.DOM.red.checked?"R":"")+(g.DOM.green.checked?"G":"")+(g.DOM.blue.checked?"B":"")),g.context.uniform3i(g.context.getUniformLocation(g.program,"uColors"),g.DOM.red.checked?1:0,g.DOM.green.checked?1:0,g.DOM.blue.checked?1:0),g.viewMgr.draw(!1)}};g.DOM.red.addEventListener("change",f,!1),g.DOM.green.addEventListener("change",f,!1),g.DOM.blue.addEventListener("change",f,!1);var h=function(a,b){var c=100/(b-a);return{a:c,b:-c*a/100}},i=function(){if(g.context&&!g.viewMgr.rendering){g.viewMgr.rendering=!0;var a=g.DOM.range1.value/2.55,b=g.DOM.range2.value/2.55,c=(g.DOM.red.checked?"f":"0")+(g.DOM.green.checked?"f":"0")+(g.DOM.blue.checked?"f":"0");g.DOM.hist.style.background=a>=b?"linear-gradient(to right, #000 0, #000 "+b+"%, #"+c+" "+a+"%, #"+c+" 100%)":"linear-gradient(to right, #"+c+" 0, #"+c+" "+a+"%, #000 "+b+"%, #000 100%)";var d=h(b,a);g.context.uniform2f(g.context.getUniformLocation(g.program,"uTransfer"),d.a,d.b),g.viewMgr.draw(!1)}};g.DOM.range1.addEventListener("input",i,!1),g.DOM.range2.addEventListener("input",i,!1),g.DOM.slider1.addEventListener("input",function(a){g.viewMgr.pick(a.target.value)},!1),g.DOM.slider2.addEventListener("input",function(a){g.viewMgr.pick(null,a.target.value)},!1)}),function(){var a=document.createElement("canvas");if(window.Worker&&window.WebGLRenderingContext&&(a.getContext("webgl")||a.getContext("experimental-webgl")))g.executeAfterDOM(function(){g.$("compatibility").classList.add("hidden")});else{var b=function(){g.$("compatibility").classList.add("hidden"),document.removeEventListener("click",b,!1)};document.addEventListener("click",b,!1)}var c=function(){var a=document.createElement("script");a.src="core/firstLoad.min.js",document.head.appendChild(a)};if(window.indexedDB){var d=window.indexedDB.open("dotplot",1);d.addEventListener("error",function(){console.log("Error opening the DB, loading data in memory"),setTimeout(function(){g.matMgr=new MatrixManager,g.seqMgr=new SequenceManager,c()},100)},!1),d.addEventListener("success",function(a){g.db=a.target.result,g.matMgr=new MatrixManager,g.seqMgr=new SequenceManager,localStorage.getItem("alreadyVisited")||c()},!1),d.addEventListener("upgradeneeded",function(a){g.db=a.target.result,g.db.objectStoreNames.contains("sequencesMetadata")||g.db.createObjectStore("sequencesMetadata",{keyPath:"key"}),g.db.objectStoreNames.contains("sequences")||g.db.createObjectStore("sequences",{autoIncrement:!0})},!1)}else g.matMgr=new MatrixManager,g.seqMgr=new SequenceManager,c()}();